
@{
    ViewData["Title"] = "ISEE: ReportJob";
    Layout = "~/Views/Shared/_MP_Back.cshtml";
    var JOBTYPE = (JOBTYPE[])ViewData["JOBTYPE"];
    var TEACHNICIAL = (TBM_EMPLOYEE[])ViewData["TEACHNICIAL"];
}
<div class="card-body">
    <div>
        <div id="divForm">
            <div class="container">

                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="txtJobDateFrom">Job Date from</label>
                        <div class="input-group mb-3">
                            <div class="input-group-append">
                                <span class="input-group-text" id="basic-addon2"><i class="far fa-calendar-alt"></i></span>
                            </div>
                            <input type="text" class="form-control" id="txtJobDateFrom" name="txtJobDateFrom">
                        </div>
                    </div>
                    <div class="form-group col-md-6">
                        <label for="txtJobDateTo">To</label>
                        <div class="input-group mb-3">
                            <div class="input-group-append">
                                <span class="input-group-text" id="basic-addon2"><i class="far fa-calendar-alt"></i></span>
                            </div>
                            <input type="text" class="form-control" id="txtJobDateTo" name="txtJobDateTo">
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="txtCustomer">Customer Name</label>
                        <input type="text" class="form-control" id="txtCustomer" name="txtCustomer" value="">
                    </div>
                    <div class="form-group col-md-6">
                        <label for="ddlJobType">Job Type</label>
                        <select id="ddlJobType" name="ddlJobType" class="form-control">
                            <option value="" selected>Choose...</option>
                            @{
                                if (JOBTYPE != null)
                                {
                                    foreach (var item in JOBTYPE)
                                    {
                                        <option value="@item.JOBCODE">@item.JOBCODE -@item.JOBDESCRIPTION</option>
                                    }
                                }
                            }
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="ddlTeachnicial">Teachnicial</label>
                        <select id="ddlTeachnicial" name="ddlTeachnicial" class="form-control">
                            <option value="" selected>Choose...</option>
                            @{
                                if (TEACHNICIAL != null)
                                {
                                    foreach (var item in TEACHNICIAL)
                                    {
                                        <option value="@item.USER_ID">@item.FULLNAME @item.LASTNAME</option>
                                    }
                                }
                            }
                        </select>
                    </div>
                    <div class="form-group col-md-6">
                        <label for="txtLicenseNo">License No</label>
                        <input type="text" class="form-control" id="txtLicenseNo" name="txtLicenseNo" value="">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="txtFixDateFrom">Fix Date from</label>
                        <div class="input-group mb-3">
                            <div class="input-group-append">
                                <span class="input-group-text" id="basic-addon2"><i class="far fa-calendar-alt"></i></span>
                            </div>
                            <input type="text" class="form-control" id="txtFixDateFrom" name="txtFixDateFrom">
                        </div>
                    </div>
                    <div class="form-group col-md-6">
                        <label for="txtFixDateTo">To</label>
                        <div class="input-group mb-3">
                            <div class="input-group-append">
                                <span class="input-group-text" id="basic-addon2"><i class="far fa-calendar-alt"></i></span>
                            </div>
                            <input type="text" class="form-control" id="txtFixDateTo" name="txtFixDateTo">
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="txtCloseJobDateFrom">Close Job Date from</label>
                        <div class="input-group mb-3">
                            <div class="input-group-append">
                                <span class="input-group-text" id="basic-addon2"><i class="far fa-calendar-alt"></i></span>
                            </div>
                            <input type="text" class="form-control" id="txtCloseJobDateFrom" name="txtCloseJobDateFrom">
                        </div>
                    </div>
                    <div class="form-group col-md-6">
                        <label for="txtCloseJobDateTo">To</label>
                        <div class="input-group mb-3">
                            <div class="input-group-append">
                                <span class="input-group-text" id="basic-addon2"><i class="far fa-calendar-alt"></i></span>
                            </div>
                            <input type="text" class="form-control" id="txtCloseJobDateTo" name="txtCloseJobDateTo">
                        </div>
                    </div>
                </div>


                <div class="col-sm-12 text-center">
                    <button id="btnSearch" type="button" style="margin:0!important" class="btn btn-info" title="Search" data-toggle="tooltip"><i class="fa fa-search"></i>&nbsp;Search</button>
                    <button id="btnClear" type="button" class="btn btn-dark" title="Clear" data-toggle="tooltip"><i class="fa fa-undo"></i>&nbsp;Clear</button>
                </div>


                <div class="row mt-5">
                    <div class="col-sm-12 text-left">
                        <button id="btnPDF" type="button" class="btn btn-success" title="PDF" data-toggle="tooltip"><i class="fa fa-file-pdf"></i>&nbsp;Print</button>
                        <button id="btnExcel" type="button" class="btn btn-warning" title="Excel" data-toggle="tooltip"><i class="fa fa-file-excel"></i>&nbsp;Export</button>
                        <button id="btnExcelDT" type="button" class="btn btn-info" title="Excel downtime" data-toggle="tooltip"><i class="fa fa-file-excel"></i>&nbsp;Export DownTime</button>
                        <button id="btnExcelRC" type="button" class="btn btn-primary" title="Excel RunningCost" data-toggle="tooltip"><i class="fa fa-file-excel"></i>&nbsp;RunningCost</button>
                        <button id="btnExcelRPT" type="button" class="btn btn-secondary" title="Excel ReportProductivetime" data-toggle="tooltip"><i class="fa fa-file-excel"></i>&nbsp;Productivetime</button>
                    </div>
                    <div id="divData" class="col-sm-12">
                        <div class="table-responsive">
                            <table id="tbSearchData" class="table tableData" style="min-width:2000px">
                                <thead class="thead-HMCPO darkCustom">
                                    <tr>
                                        <th class="text-center">job no</th>
                                        <th class="text-center">job create</th>
                                        <th class="text-center">license no</th>
                                        <th class="text-center">emp name</th>
                                        <th class="text-center">summary</th>
                                        <th class="text-center">fix date</th>
                                        <th class="text-center">close date</th>
                                        <th class="text-center">customer name</th>
                                        <th class="text-center">invoice no</th>
                                        <th class="text-center">type job</th>
                                        <th style="text-align:center"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    var urlSearchData = "@Url.Action("GetData", "ReportJob")";
    let urlRptDowntime = "@Url.Action("sp_getReportDownTime", "ReportJob")";
    let urlRptRunningCost = "@Url.Action("sp_getReportRunningCost", "ReportJob")";
    let urlReportProductivetime = "@Url.Action("sp_getReportProductive_time", "ReportJob")";
    $(document).ready(function () {
        $('#ddlJobType').select2();
        $('#ddlTeachnicial').select2();

        SetDateRangePicker($('#txtJobDateFrom'), $('#txtJobDateTo'));
        SetDateRangePicker($('#txtFixDateFrom'), $('#txtFixDateTo'));
        SetDateRangePicker($('#txtCloseJobDateFrom'), $('#txtCloseJobDateTo'));

        SearchData('SEARCH');

        $('#btnSearch').on('click', function () {
            SearchData('SEARCH');
        });
        $('#btnPDF').on('click', function () {
            SearchData('PDF');
        });
        $('#btnExcel').on('click', function () {
            SearchData('EXCEL');
        });
        $('#btnExcelDT').on('click', function () {
            rptdowntime();
        });
        $('#btnExcelRC').on('click', function () {
            rptRunningCost();
        });
        $('#btnExcelRPT').on('click', function () {
            rptReportProductivetime();
        });
        $('#btnClear').on('click', function () {
            $('#txtJobDateFrom').val('');
            $('#txtJobDateTo').val('');
            $('#txtCustomer').val('');
            $('#ddlJobType').val('');
            $('#ddlTeachnicial').val('');
            $('#txtLicenseNo').val('');
            $('#txtFixDateFrom').val('');
            $('#txtFixDateTo').val('');
            $('#txtCloseJobDateFrom').val('');
            $('#txtCloseJobDateTo').val('');
            $('#ddlJobType').select2();
            $('#ddlTeachnicial').select2();
        });
    });

    function SearchData(type) {
        var obj = {
            JOB_DATE_FROM: GetValTextBox('txtJobDateFrom'),
            JOB_DATE_TO: GetValTextBox('txtJobDateTo'),
            CUSTOMER_NAME: GetValTextBox('txtCustomer'),
            FIX_DATE_FROM: GetValTextBox('txtFixDateFrom'),
            FIX_DATE_TO: GetValTextBox('txtFixDateTo'),
            CLOSE_DT_FROM: GetValTextBox('txtCloseJobDateFrom'),
            CLOSE_DT_TO: GetValTextBox('txtCloseJobDateTo'),
            LICENSE_NO: GetValTextBox('txtLicenseNo'),
            USER_PRINT: "",
            TYPE_JOB: GetValDropdown('ddlJobType'),
            TEACHNICIAL: GetValDropdown('ddlTeachnicial'),
            REPORT_TYPE: type,
        }

        BlockUI();
        $.ajax({
            url: urlSearchData,
            type: 'POST',
            dataType: 'json',
            data: { 'data': obj },
            success: function (response) {
                UnblockUI();
                if (response.Status == SysProcess.SessionExpired) {
                    PopupSessionTimeOut('@Url.Action("Index","Login")');
                } else if (response.Status == SysProcess.Failed) {
                    DialogWarning(response.Msg);
                } else {
                    if (TypeReport.SEARCH == type) {
                        BindDataTable(response.data.SUMMARY_JOB_LIST);
                    } else if (TypeReport.EXCEL == type) {
                        var url = '@Url.Action("PreviewFile", "ReportJob", new { SessionRpt = "ID" })'.replace("ID", response.data);
                                window.open(url, '_blank');
                    } else if (TypeReport.PDF == type) {
                        var url = '@Url.Action("PreviewFile", "ReportJob", new { SessionRpt = "ID" })'.replace("ID", response.data);
                                window.open(url, '_blank');
                    }

                }
            },
            error: function () {
            }
        });
    }

    function BindDataTable(arrData_) {
        var table = $('#tbSearchData').DataTable();
        table.destroy();

        $("#tbSearchData tbody").html("");
            let html = '';
            $.each(arrData_, function (i, el) {
                let td = '';
                td = '<td class="text-center">' + (el.JOB_ID || '') + '</td>';
                td += '<td class="text-center">' + (el.CREATE_DATE || '') + '</td>';
                td += '<td class="text-left">' + (el.LICENSE_NO || '') + '</td>';
                td += '<td class="text-left">' + (el.EMPLOYEENAME || '') + '</td>';
                td += '<td class="text-right">' + (el.SUMMARY || '') + '</td>';
                td += '<td class="text-right">' + (el.FIX_DATE || '') + '</td>';
                td += '<td class="text-right">' + (el.CLOSE_DATE || '') + '</td>';
                td += '<td class="text-left">' + (el.CUSTOMERNAME || '') + '</td>';
                td += '<td class="text-right">' + (el.INVOICE_NO || '') + '</td>';
                td += '<td class="text-left">' + (el.JOBDESCRIPTION || '') + '</td>';
                td += '<td class="text-center">' + '<a href="@Url.Action("ViewImage", "Job")' + '?IJOB_ID=' + el.JOB_ID_ENCRYPT + '&&SEQ=' + el.SEQ_ENCRYPT + '" target="_blank" class="btn btn-sm btn-info"><i class="fas fa-eye"></i></a>' + '</td>';

                html += "<tr>" + td + "</tr>";
            });

        $("table[id$=tbSearchData] tbody").html(html);

        var table = $('#tbSearchData').DataTable({
            //scrollY: "300px",
            scrollX: true,
            scrollCollapse: true,
            paging: false,
            //columnDefs: [
            //    {
            //        orderable: false,
            //        className: 'select-checkbox',
            //        targets: 0
            //    }
            //    , { width: 35, targets: 0 }
            //    , { width: 70, targets: 1 }
            //    , { width: 350, targets: 3 }
            //],
        });
    }

    const rptdowntime = () => {
        let obj = {
            JOB_DATE_FROM: GetValTextBox('txtJobDateFrom'),
            JOB_DATE_TO: GetValTextBox('txtJobDateTo'),
            CUSTOMER_NAME: GetValTextBox('txtCustomer'),
            FIX_DATE_FROM: GetValTextBox('txtFixDateFrom'),
            FIX_DATE_TO: GetValTextBox('txtFixDateTo'),
            CLOSE_DT_FROM: GetValTextBox('txtCloseJobDateFrom'),
            CLOSE_DT_TO: GetValTextBox('txtCloseJobDateTo'),
            LICENSE_NO: GetValTextBox('txtLicenseNo'),
            USER_PRINT: "",
            TYPE_JOB: GetValDropdown('ddlJobType'),
            TEACHNICIAL: GetValDropdown('ddlTeachnicial')
        }

        BlockUI();
        $.ajax({
            url: urlRptDowntime,
            type: 'POST',
            dataType: 'json',
            data: { 'data': obj },
            success: function (response) {
                UnblockUI();
                if (response.Status == SysProcess.SessionExpired) {
                    PopupSessionTimeOut('@Url.Action("Index","Login")');
                } else if (response.Status == SysProcess.Failed) {
                    DialogWarning(response.Msg);
                } else {
                        let url = '@Url.Action("PreviewFile", "ReportJob", new { SessionRpt = "ID" })'.replace("ID", response.data);
                                window.open(url, '_blank');
                }
            },
            error: function () {
            }
        });
    }
    const rptRunningCost = () => {
        let obj = {
            JOB_DATE_FROM: GetValTextBox('txtJobDateFrom'),
            JOB_DATE_TO: GetValTextBox('txtJobDateTo'),
            CUSTOMER_NAME: GetValTextBox('txtCustomer'),
            FIX_DATE_FROM: GetValTextBox('txtFixDateFrom'),
            FIX_DATE_TO: GetValTextBox('txtFixDateTo'),
            CLOSE_DT_FROM: GetValTextBox('txtCloseJobDateFrom'),
            CLOSE_DT_TO: GetValTextBox('txtCloseJobDateTo'),
            LICENSE_NO: GetValTextBox('txtLicenseNo'),
            USER_PRINT: "",
            TYPE_JOB: GetValDropdown('ddlJobType'),
            TEACHNICIAL: GetValDropdown('ddlTeachnicial')
        }

        BlockUI();
        $.ajax({
            url: urlRptRunningCost,
            type: 'POST',
            dataType: 'json',
            data: { 'data': obj },
            success: function (response) {
                UnblockUI();
                if (response.Status == SysProcess.SessionExpired) {
                    PopupSessionTimeOut('@Url.Action("Index","Login")');
                } else if (response.Status == SysProcess.Failed) {
                    DialogWarning(response.Msg);
                } else {
                        let url = '@Url.Action("PreviewFile", "ReportJob", new { SessionRpt = "ID" })'.replace("ID", response.data);
                                window.open(url, '_blank');
                }
            },
            error: function () {
            }
        });
    }
    const rptReportProductivetime = () => {
        let obj = {
            JOB_DATE_FROM: GetValTextBox('txtJobDateFrom'),
            JOB_DATE_TO: GetValTextBox('txtJobDateTo'),
            CUSTOMER_NAME: GetValTextBox('txtCustomer'),
            FIX_DATE_FROM: GetValTextBox('txtFixDateFrom'),
            FIX_DATE_TO: GetValTextBox('txtFixDateTo'),
            CLOSE_DT_FROM: GetValTextBox('txtCloseJobDateFrom'),
            CLOSE_DT_TO: GetValTextBox('txtCloseJobDateTo'),
            LICENSE_NO: GetValTextBox('txtLicenseNo'),
            USER_PRINT: "",
            TYPE_JOB: GetValDropdown('ddlJobType'),
            TEACHNICIAL: GetValDropdown('ddlTeachnicial')
        }

        BlockUI();
        $.ajax({
            url: urlReportProductivetime,
            type: 'POST',
            dataType: 'json',
            data: { 'data': obj },
            success: function (response) {
                UnblockUI();
                if (response.Status == SysProcess.SessionExpired) {
                    PopupSessionTimeOut('@Url.Action("Index","Login")');
                } else if (response.Status == SysProcess.Failed) {
                    DialogWarning(response.Msg);
                } else {
                    let url = '@Url.Action("PreviewFile", "ReportJob", new { SessionRpt = "ID" })'.replace("ID", response.data);
                    window.open(url, '_blank');
                }
            },
            error: function () {
            }
        });
    }
</script>
